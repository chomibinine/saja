<script>
    document.addEventListener("DOMContentLoaded", () => {
        const correctMessages = [ "정답이야! 완벽한데?", "역시 바로 맞히네!", "폼 미쳤다!", "대단해! 어떻게 바로 알았지?", "너 천재 아니야?", "굿! 이 기세로 계속 가자!", "아주 정확했어!", "이 사자성어는 이제 네 거네!", "최고야! 다음 문제도 풀어보자.", "나이스! 깔끔했다.", "완전 똑똑한데?", "공부한 보람이 있네!", "이걸 맞히네! 집중력 대박.", "실력이 쑥쑥 느는구나!", "망설임이 없었어! 멋있다.", "좋았어! 콤보 계속 가자!", "사자성어 마스터가 되겠는데?", "바로 이거지! 느낌 좋다.", "그렇지! 최고!", "이 게임 아빠가 만들었구나!" ];
        const wrongMessages = [ "아쉽다! 거의 맞혔는데!", "괜찮아, 틀리면서 배우는 거지!", "까비! 다음엔 꼭 맞힐 수 있어.", "이 사자성어 이제 확실히 외웠겠다!", "한 번 미끄러졌네!", "괜찮아, 괜찮아.", "이건 좀 헷갈리는 문제였어,", "오답 노트에 저장!", "다시 집중해보자!", "포기만 안 하면 돼!", "너무 자책하지 마.", "음, 이건 좀 어려웠다.", "괜찮아, 익히는 과정이야!", "다시 한번 보면 되지!", "다음 문제에 집중!", "잘못 고른거 아냐?.", "에이, 괜찮아!.", "아깝다! 한 끗 차이였는데.", "헷갈렸구나?", "심호흡 한번 하고 다시 가자!" ];
        
        let userData = {}, currentUserId = null, allUsers = {}, soundEnabled = true, currentQuizRange = null;

        const startScreen = document.getElementById('start-screen'), quizScreen = document.getElementById('quiz-screen'), resultScreen = document.getElementById('result-screen'), startBtn = document.getElementById('start-btn'), restartBtn = document.getElementById('restart-btn'), retryIncorrectBtn = document.getElementById('retry-incorrect-btn'), questionText = document.getElementById('question-text'), optionButtons = document.querySelectorAll('.option'), scoreText = document.getElementById('score-text'), progressBar = document.getElementById('progress-bar'), timerDisplay = document.getElementById('timer'), characterFeedback = document.getElementById('character-feedback'), incorrectSection = document.getElementById('incorrect-answers-section'), incorrectList = document.getElementById('incorrect-answers-list'), levelDisplay = document.getElementById('level-display'), xpDisplay = document.getElementById('xp-display'), progressDisplay = document.getElementById('progress-display'), progressPercent = document.getElementById('progress-percent'), achievementPopup = document.getElementById('achievement-unlocked'), quizSelectionContainer = document.getElementById('quiz-selection'), hintBtn = document.getElementById('hint-btn'), quizStatsDisplay = document.getElementById('quiz-stats-display'), correctSound = document.getElementById('correct-sound'), incorrectSound = document.getElementById('incorrect-sound'), achievementSound = document.getElementById('achievement-sound'), mainTitle = document.getElementById('main-title'), settingsBtn = document.getElementById('settings-btn'), settingsModal = document.getElementById('settings-modal'), userSelect = document.getElementById('user-select'), addUserBtn = document.getElementById('add-user-btn'), deleteUserBtn = document.getElementById('delete-user-btn'), soundToggle = document.getElementById('sound-toggle'), closeSettingsBtn = document.getElementById('close-settings'), userMessage = document.getElementById('user-message'), nextQBtn = document.getElementById('next-q-btn'), gameMessageSpot = document.getElementById('game-message-spot');

        let currentQuizData = [], incorrectAnswersThisRound = [], comboCount = 0, currentQuestionIndex = 0, score = 0, timer, timeLeft = 15;
        let showWordAsQuestion = false, autoAdvance = true;

        const fullQuizData = [
            // (사자성어 데이터는 양이 많아 생략합니다.)
            { "id": 1, "question": "크게 소리 내어 웃는 것", "answer": "가가대소(呵呵大笑)", "options": ["교자채신(敎子採薪)","가가대소(呵呵大笑)","농가성진(弄假成眞)","낙화유수(落花流水)"], "hint": "呵(꾸짖을 가/웃음소리 가) 웃다의 의성어 呵呵 하하 웃는 웃음소리 大(큰 대) 크다 笑(웃을 소) 웃다" },
            { "id": 2, "question": "집집마다 모든 집을 의미함", "answer": "가가호호(家家戶戶)", "options": ["박람강기(博覽強記)","풍수지탄(風樹之嘆)","낭중지추(囊中之錐)","가가호호(家家戶戶)"], "hint": "한자 풀이 家(집 가) 가정 집 家(집 가) 가정 집 戶(집 호) 문 집 가구 戶(집 호) 문 집 가구" },
            // ...
            { "id": 400, "question": "검은 고양이든 흰 고양이든 쥐만 잘 잡으면 좋은 고양이다", "answer": "흑묘백묘(黑猫白猫)", "options": ["금상첨화(錦上添花)","화합동진(和合同進)","흑묘백묘(黑猫白猫)","유구무언(有口無言)"], "hint": "한자 풀이 黑(검을 흑) 검은색 猫(고양이 묘) 고양이 白(흰 백) 흰색 猫(고양이 묘) 고양이" }
        ];

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('i');
            const isActive = content.style.display === "block";
            document.querySelectorAll(".accordion-content").forEach(c => {
                c.style.display = "none";
                const i = c.previousElementSibling.querySelector('i');
                if (i) i.textContent = '▼';
            });
            if (!isActive) {
                content.style.display = "block";
                if (icon) icon.textContent = '▲';
            }
        }

        function showGameMessage(htmlContent, duration = 2000) {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = htmlContent;
            gameMessageSpot.innerHTML = '';
            gameMessageSpot.appendChild(messageElement);
            setTimeout(() => {
                if (gameMessageSpot.contains(messageElement)) {
                    gameMessageSpot.removeChild(messageElement);
                }
            }, duration);
        }

        function addXp(amount) {
            userData.xp += amount;
            if (userData.xp < 0) userData.xp = 0;
            const requiredXp = userData.level * 1000;
            if (userData.xp >= requiredXp) {
                userData.xp -= requiredXp;
                userData.level++;
                showGameMessage(`<div class="levelup-message">✨ LEVEL UP! LV.${userData.level}</div>`, 3000);
                showAchievement(`✨🏆✨ LEVEL UP! LV.${userData.level} 달성을 축하합니다!`);
            }
            const message = amount > 0 ? `+${amount}XP` : `${amount}XP`;
            showGameMessage(`<div class="xp-message">${message}</div>`);
            saveUserData();
            updateDashboard();
        }

        function selectAnswer(e) {
            clearInterval(timer);
            timerDisplay.classList.add('hidden');
            const selectedButton = e.target.closest('button');
            if (!selectedButton) return;
            const selectedAnswer = selectedButton.dataset.answer;
            const currentQuestion = currentQuizData[currentQuestionIndex];
            const correctAnswer = showWordAsQuestion ? currentQuestion.question : currentQuestion.answer;
            hintBtn.classList.add('hidden');
            showHint(true);
            if (selectedAnswer === correctAnswer) {
                selectedButton.classList.add('correct');
                score++;
                comboCount++;
                let baseXp = 100 + (comboCount >= 2 ? comboCount * 10 : 0);
                addXp(baseXp);
                playSound(correctSound);
                const randomMessage = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                characterFeedback.textContent = `${currentUserId}, ${randomMessage}`;
                characterFeedback.style.color = 'var(--correct-color)';
                characterFeedback.classList.add('show');
                if (comboCount >= 2) {
                    setTimeout(() => showGameMessage(`<div class="combo-message">🔥 ${comboCount} COMBO!</div>`), 500);
                }
                if (!userData.masteredWords.includes(currentQuestion.id)) {
                    userData.masteredWords.push(currentQuestion.id);
                }
                userData.incorrectNote = userData.incorrectNote.filter(id => id !== currentQuestion.id);
            } else {
                selectedButton.classList.add('incorrect');
                incorrectAnswersThisRound.push(currentQuestion);
                comboCount = 0;
                playSound(incorrectSound);
                const randomMessage = wrongMessages[Math.floor(Math.random() * wrongMessages.length)];
                characterFeedback.textContent = `${currentUserId}, ${randomMessage}`;
                characterFeedback.style.color = 'var(--incorrect-color)';
                characterFeedback.classList.add('show');
                if (!userData.incorrectNote.includes(currentQuestion.id)) {
                    userData.incorrectNote.push(currentQuestion.id);
                }
                optionButtons.forEach(button => {
                    if (button.dataset.answer === correctAnswer) button.classList.add('correct');
                });
            }
            optionButtons.forEach(button => button.disabled = true);
            if (autoAdvance) {
                moveToNextQuestion(2000);
            } else {
                nextQBtn.classList.remove('hidden');
            }
        }

        function resetState() {
            characterFeedback.classList.remove('show');
            optionButtons.forEach(button => {
                button.disabled = false;
                button.className = 'option';
            });
            nextQBtn.classList.add('hidden');
            gameMessageSpot.innerHTML = '';
            hintBtn.classList.remove('hidden');
        }

        function handleTimeUp() {
            clearInterval(timer);
            const currentQuestion = currentQuizData[currentQuestionIndex];
            const correctAnswer = showWordAsQuestion ? currentQuestion.question : currentQuestion.answer;
            incorrectAnswersThisRound.push(currentQuestion);
            if (!userData.incorrectNote.includes(currentQuestion.id)) {
                userData.incorrectNote.push(currentQuestion.id);
            }
            comboCount = 0;
            playSound(incorrectSound);
            const randomMessage = wrongMessages[Math.floor(Math.random() * wrongMessages.length)];
            characterFeedback.textContent = `시간 초과! ${currentUserId}, ${randomMessage}`;
            characterFeedback.classList.add('show');
            characterFeedback.style.color = 'var(--incorrect-color)';
            optionButtons.forEach(button => {
                if (button.dataset.answer === correctAnswer) button.classList.add('correct');
                button.disabled = true;
            });
            if (autoAdvance) {
                moveToNextQuestion(2000);
            } else {
                nextQBtn.classList.remove('hidden');
            }
        }

        function playSound(sound) {
            if (!soundEnabled) return;
            sound.currentTime = 0;
            sound.play().catch(e => console.warn("Sound play was blocked."));
        }

        // --- Settings Functions ---
        function loadSettings() {
            const savedSound = localStorage.getItem('soundEnabled');
            soundEnabled = savedSound === null ? true : JSON.parse(savedSound);
            soundToggle.checked = soundEnabled;

            const savedDirection = localStorage.getItem('showWordAsQuestion');
            showWordAsQuestion = savedDirection === 'true';
            document.getElementById('question-direction-toggle').checked = showWordAsQuestion;

            const savedAutoAdvance = localStorage.getItem('autoAdvanceEnabled');
            autoAdvance = savedAutoAdvance === null ? true : savedAutoAdvance === 'true';
            document.getElementById('auto-advance-toggle').checked = autoAdvance;

            const savedDarkMode = localStorage.getItem('darkModeEnabled');
            const isDarkMode = savedDarkMode === 'true';
            document.getElementById('dark-mode-toggle').checked = isDarkMode;
            applyDarkMode(isDarkMode);

            const savedCustomToggle = localStorage.getItem('customSettingEnabled');
            document.getElementById('custom-setting-toggle').checked = savedCustomToggle === 'true';
            updateQuizSelectionVisibility();
        }

        function applyDarkMode(enabled) {
            document.body.classList.toggle('dark-mode', enabled);
        }

        function updateQuizSelectionVisibility() {
            const useCustom = document.getElementById('custom-setting-toggle').checked;
            document.getElementById('quiz-selection').style.display = useCustom ? 'none' : 'block';
            document.getElementById('custom-quiz-selection').style.display = useCustom ? 'block' : 'none';
        }

        // --- User Management ---
        function loadAllUsers() {
            const savedUsers = localStorage.getItem('wordMasterUsers');
            if (savedUsers) {
                allUsers = JSON.parse(savedUsers);
            } else {
                allUsers['초미비니'] = { level: 1, xp: 0, masteredWords: [], incorrectNote: [], achievements: [] };
                saveAllUsers();
            }
        }

        function createUser(username) {
            username = username?.trim();
            if (!username) return false;
            if (username.length > 8) {
                showUserMessage("❌ 사용자명은 최대 8자까지 가능합니다!");
                return false;
            }
            if (allUsers[username]) {
                showUserMessage('❗ 이미 존재하는 사용자입니다!');
                return false;
            }
            allUsers[username] = { level: 1, xp: 0, masteredWords: [], incorrectNote: [], achievements: [] };
            saveAllUsers();
            populateUserSelect();
            setCurrentUser(username);
            showUserMessage(`"🎉 ${username}" 사용자가 생성되었습니다!`);
            return true;
        }

        function addUser() {
            const newUsername = prompt('새 사용자 이름을 입력하세요 (최대 8자):', '');
            if (newUsername) createUser(newUsername);
        }

        function deleteUser() {
            const username = userSelect.value;
            if (!username) { showUserMessage('삭제할 사용자를 선택해주세요!'); return; }
            if (Object.keys(allUsers).length <= 1) { showUserMessage('최소 한 명의 사용자가 필요합니다!'); return; }
            if (!confirm(`"${username}" 사용자를 정말 삭제하시겠습니까? 모든 학습 데이터가 사라집니다!`)) return;
            delete allUsers[username];
            saveAllUsers();
            populateUserSelect();
            const firstUserId = Object.keys(allUsers)[0];
            if (firstUserId) {
                setCurrentUser(firstUserId);
            }
        }

        function populateUserSelect() {
            userSelect.innerHTML = '';
            Object.keys(allUsers).forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                userSelect.appendChild(option);
            });
            if (currentUserId) userSelect.value = currentUserId;
        }

        function setCurrentUser(username) {
            if (!allUsers[username]) return;
            currentUserId = username;
            userData = allUsers[username];
            userSelect.value = username;
            updateDashboard();
            mainTitle.innerHTML = `${currentUserId}의<br>사자성어 쪼개기`;
        }

        function showUserMessage(message) {
            userMessage.textContent = message;
            userMessage.classList.add('show');
            setTimeout(() => userMessage.classList.remove('show'), 3000);
        }

        function saveAllUsers() {
            localStorage.setItem('wordMasterUsers', JSON.stringify(allUsers));
        }

        function saveUserData() {
            if (currentUserId) {
                allUsers[currentUserId] = userData;
                saveAllUsers();
            }
        }

        // --- UI Updates ---
        function updateDashboard() {
            if (!userData) return;
            levelDisplay.textContent = userData.level;
            xpDisplay.textContent = userData.xp;
            const masteredCount = new Set(userData.masteredWords).size;
            const totalCount = fullQuizData.length;
            progressDisplay.textContent = `${masteredCount} / ${totalCount}`;
            const percent = totalCount > 0 ? ((masteredCount / totalCount) * 100).toFixed(1) : 0;
            progressPercent.textContent = ` (${percent}%)`;
            const incorrectCount = new Set(userData.incorrectNote).size;
            document.getElementById('incorrect-count').textContent = incorrectCount;
            const incorrectRadioLabel = document.querySelector('label.quiz-range input[value="incorrect"]')?.parentElement;
            if (incorrectRadioLabel) {
                if (incorrectCount === 0) {
                    incorrectRadioLabel.style.opacity = '0.5';
                    incorrectRadioLabel.style.pointerEvents = 'none';
                } else {
                    incorrectRadioLabel.style.opacity = '1';
                    incorrectRadioLabel.style.pointerEvents = 'auto';
                }
            }
            updateQuizStats();
        }

        function updateQuizStats() {
            if (!userData) return;
            const requiredXp = userData.level * 1000;
            quizStatsDisplay.innerHTML = `<strong>LV.${userData.level}</strong> (${userData.xp}/${requiredXp} XP)`;
        }

        function showAchievement(message) {
            achievementPopup.textContent = message;
            achievementPopup.classList.add('show');
            playSound(achievementSound);
            setTimeout(() => achievementPopup.classList.remove('show'), 3000);
        }

        // --- Quiz Flow ---
        function createQuizSelection() {
            quizSelectionContainer.innerHTML = '';
            const wordsPerGroup = 20;
            const groupCount = Math.ceil(fullQuizData.length / wordsPerGroup);
            for (let i = 0; i < groupCount; i++) {
                const startNum = i * wordsPerGroup + 1;
                const endNum = Math.min((i + 1) * wordsPerGroup, fullQuizData.length);
                const label = document.createElement('label');
                label.className = 'quiz-range';
                label.innerHTML = `<input type="radio" name="quizRange" value="${startNum - 1}-${endNum - 1}"><span> #${String(startNum).padStart(4, '0')} ~ #${String(endNum).padStart(4, '0')}</span>`;
                quizSelectionContainer.appendChild(label);
            }
            const incorrectLabel = document.createElement('label');
            incorrectLabel.className = 'quiz-range';
            incorrectLabel.innerHTML = `<input type="radio" name="quizRange" value="incorrect"><span> 오답 노트 챌린지 (<span id="incorrect-count">0</span>개)</span>`;
            quizSelectionContainer.appendChild(incorrectLabel);
        }

        function startQuiz() {
            const useCustom = document.getElementById('custom-setting-toggle').checked;
            if (useCustom) {
                let startIdx = parseInt(document.getElementById('custom-range-start').value) - 1;
                let endIdx = parseInt(document.getElementById('custom-range-end').value);
                let count = parseInt(document.getElementById('custom-question-count').value || 5);
                if (isNaN(startIdx) || isNaN(endIdx) || startIdx < 0 || endIdx <= startIdx || endIdx > fullQuizData.length) { alert('유효한 퀴즈 범위를 입력해주세요.'); return; }
                if (isNaN(count) || count < 3 || count > 20) { alert('문제 수는 3에서 20 사이로 설정해주세요.'); return; }
                currentQuizData = fullQuizData.slice(startIdx, endIdx).sort(() => 0.5 - Math.random()).slice(0, count);
            } else {
                const selectedRadio = document.querySelector('input[name="quizRange"]:checked');
                if (!selectedRadio) { alert('퀴즈 범위를 선택해주세요!'); return; }
                currentQuizRange = selectedRadio.value;
                if (currentQuizRange === 'incorrect') {
                    if (userData.incorrectNote.length === 0) { alert('오답 노트가 비어있습니다!'); return; }
                    const incorrectNoteSet = new Set(userData.incorrectNote);
                    currentQuizData = fullQuizData.filter(q => incorrectNoteSet.has(q.id)).sort(() => 0.5 - Math.random());
                } else {
                    const [startId, endId] = currentQuizRange.split('-').map(Number);
                    currentQuizData = fullQuizData.slice(startId, endId + 1).sort(() => 0.5 - Math.random());
                }
            }
            if (currentQuizData.length === 0) { alert('선택한 범위에 문제가 없습니다.'); return; }
            incorrectAnswersThisRound = [];
            currentQuestionIndex = 0;
            score = 0;
            comboCount = 0;
            updateQuizStats();
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            showQuestion();
        }
        
        function startTimer() {
            timeLeft = 15;
            timerDisplay.textContent = timeLeft;
            timerDisplay.classList.remove('hidden');
            clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    handleTimeUp();
                }
            }, 1000);
        }

        function showQuestion() {
            resetState();
            const currentQuestion = currentQuizData[currentQuestionIndex];
            let questionHTML = `Q${currentQuestionIndex + 1}. `;
            let options = [];
            if (showWordAsQuestion) {
                questionHTML += `<strong>${currentQuestion.answer}</strong>`;
                const distractors = fullQuizData.filter(q => q.id !== currentQuestion.id);
                options = distractors.sort(() => 0.5 - Math.random()).slice(0, 3).map(q => q.question);
                options.push(currentQuestion.question);
            } else {
                questionHTML += currentQuestion.question;
                options = [...currentQuestion.options];
            }
            questionText.innerHTML = questionHTML;
            const shuffledOptions = options.sort(() => 0.5 - Math.random());
            optionButtons.forEach((button, index) => {
                button.innerText = shuffledOptions[index];
                button.dataset.answer = shuffledOptions[index];
            });
            hintBtn.classList.remove('hidden');
            updateProgressBar();
            startTimer();
        }
        
        function moveToNextQuestion(delay = 0) { setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < currentQuizData.length) { showQuestion(); } else { showResult(); } }, delay); }
        function updateProgressBar() { const progress = ((currentQuestionIndex + 1) / currentQuizData.length) * 100; progressBar.style.width = `${progress}%`; }

        function showResult() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            scoreText.innerHTML = `총 <strong>${currentQuizData.length}</strong> 문제 중 <strong>${score}</strong>개를 맞혔습니다!`;
            if (incorrectAnswersThisRound.length > 0) {
                incorrectSection.classList.remove('hidden');
                retryIncorrectBtn.classList.remove('hidden');
                incorrectList.innerHTML = '';
                incorrectAnswersThisRound.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${item.answer}</strong>: ${item.question}`;
                    incorrectList.appendChild(li);
                });
            } else {
                incorrectSection.classList.add('hidden');
                retryIncorrectBtn.classList.add('hidden');
                scoreText.innerHTML += "<br>🎉 <strong>완벽해요!</strong>";
                if (currentQuizData.length >= 10 && !userData.achievements.includes('perfect10')) {
                    showAchievement('🏆 도전 과제: 10문제 이상 완벽 클리어!');
                    userData.achievements.push('perfect10');
                }
            }
            saveUserData();
            updateDashboard();
        }

        function showHint(force = false) {
            const currentQuestion = currentQuizData?.[currentQuestionIndex];
            if (!currentQuestion) return;
            const hintContent = currentQuestion?.hint ? `<small style='font-size:1rem; color:#666;'>💡 ${currentQuestion.hint}</small>` : "<small style='font-size:1rem; color:#999;'>❗ 힌트가 제공되지 않습니다.</small>";
            questionText.innerHTML = hintContent;
            hintBtn.classList.add('hidden');
        }

        function showStartScreen() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            document.querySelectorAll(".quiz-range.selected").forEach(r => r.classList.remove("selected"));
            startBtn.disabled = true;
            startBtn.textContent = '퀴즈 범위를 선택하세요';
            currentQuizRange = null;
        }

        // --- Initializer ---
        function initializeApp() {
            loadAllUsers();
            createQuizSelection();
            populateUserSelect();
            
            const firstUserId = Object.keys(allUsers)[0];
            if (firstUserId) {
                setCurrentUser(firstUserId);
            }
            
            loadSettings();

            // --- Event Listeners ---
            startBtn.addEventListener('click', startQuiz);
            restartBtn.addEventListener('click', showStartScreen);
            retryIncorrectBtn.addEventListener('click', () => {
                const incorrectRadio = quizSelectionContainer.querySelector('input[value="incorrect"]');
                if (incorrectRadio) {
                    incorrectRadio.checked = true;
                    // Manually trigger visual update for selection
                    document.querySelectorAll('.quiz-range').forEach(label => label.classList.remove('selected'));
                    incorrectRadio.parentElement.classList.add('selected');
                }
                startQuiz();
            });

            nextQBtn.addEventListener('click', () => moveToNextQuestion());
            optionButtons.forEach(button => button.addEventListener('click', selectAnswer));
            hintBtn.addEventListener('click', () => showHint(false));
            
            settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            
            addUserBtn.addEventListener('click', addUser);
            deleteUserBtn.addEventListener('click', deleteUser);
            userSelect.addEventListener('change', () => setCurrentUser(userSelect.value));
            
            // Settings Toggles
            soundToggle.addEventListener('change', () => { soundEnabled = soundToggle.checked; localStorage.setItem('soundEnabled', soundEnabled); });
            document.getElementById('question-direction-toggle').addEventListener('change', (e) => { showWordAsQuestion = e.target.checked; localStorage.setItem('showWordAsQuestion', showWordAsQuestion); });
            document.getElementById('auto-advance-toggle').addEventListener('change', (e) => { autoAdvance = e.target.checked; localStorage.setItem('autoAdvanceEnabled', autoAdvance); });
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => { const isEnabled = e.target.checked; applyDarkMode(isEnabled); localStorage.setItem('darkModeEnabled', isEnabled); });
            document.getElementById('custom-setting-toggle').addEventListener('change', (e) => { updateQuizSelectionVisibility(); localStorage.setItem('customSettingEnabled', e.target.checked); });
            
            // ✅ **FIX**: Event listener for quiz selection
            quizSelectionContainer.addEventListener('click', (e) => {
                const targetLabel = e.target.closest('.quiz-range');
                if (!targetLabel) return;
                
                const radio = targetLabel.querySelector('input[type="radio"]');
                if (radio && radio.disabled) return;

                document.querySelectorAll('.quiz-range').forEach(label => label.classList.remove('selected'));
                targetLabel.classList.add('selected');

                if (radio) { radio.checked = true; }
                
                startBtn.disabled = false;
                startBtn.textContent = '퀴즈 시작!';
            });

            // ✅ **FIX**: Event listener for settings accordion
            document.querySelectorAll('.accordion-section > div:first-child').forEach(header => {
                header.addEventListener('click', () => {
                    toggleAccordion(header);
                });
            });
        }
        
        // Let's go!
        initializeApp();
    });
</script>
