<script>
    document.addEventListener("DOMContentLoaded", () => {
        const correctMessages = [ "ì •ë‹µì´ì•¼! ì™„ë²½í•œë°?", "ì—­ì‹œ ë°”ë¡œ ë§íˆë„¤!", "í¼ ë¯¸ì³¤ë‹¤!", "ëŒ€ë‹¨í•´! ì–´ë–»ê²Œ ë°”ë¡œ ì•Œì•˜ì§€?", "ë„ˆ ì²œì¬ ì•„ë‹ˆì•¼?", "êµ¿! ì´ ê¸°ì„¸ë¡œ ê³„ì† ê°€ì!", "ì•„ì£¼ ì •í™•í–ˆì–´!", "ì´ ì‚¬ìì„±ì–´ëŠ” ì´ì œ ë„¤ ê±°ë„¤!", "ìµœê³ ì•¼! ë‹¤ìŒ ë¬¸ì œë„ í’€ì–´ë³´ì.", "ë‚˜ì´ìŠ¤! ê¹”ë”í–ˆë‹¤.", "ì™„ì „ ë˜‘ë˜‘í•œë°?", "ê³µë¶€í•œ ë³´ëŒì´ ìˆë„¤!", "ì´ê±¸ ë§íˆë„¤! ì§‘ì¤‘ë ¥ ëŒ€ë°•.", "ì‹¤ë ¥ì´ ì‘¥ì‘¥ ëŠëŠ”êµ¬ë‚˜!", "ë§ì„¤ì„ì´ ì—†ì—ˆì–´! ë©‹ìˆë‹¤.", "ì¢‹ì•˜ì–´! ì½¤ë³´ ê³„ì† ê°€ì!", "ì‚¬ìì„±ì–´ ë§ˆìŠ¤í„°ê°€ ë˜ê² ëŠ”ë°?", "ë°”ë¡œ ì´ê±°ì§€! ëŠë‚Œ ì¢‹ë‹¤.", "ê·¸ë ‡ì§€! ìµœê³ !", "ì´ ê²Œì„ ì•„ë¹ ê°€ ë§Œë“¤ì—ˆêµ¬ë‚˜!" ];
        const wrongMessages = [ "ì•„ì‰½ë‹¤! ê±°ì˜ ë§í˜”ëŠ”ë°!", "ê´œì°®ì•„, í‹€ë¦¬ë©´ì„œ ë°°ìš°ëŠ” ê±°ì§€!", "ê¹Œë¹„! ë‹¤ìŒì—” ê¼­ ë§í ìˆ˜ ìˆì–´.", "ì´ ì‚¬ìì„±ì–´ ì´ì œ í™•ì‹¤íˆ ì™¸ì› ê² ë‹¤!", "í•œ ë²ˆ ë¯¸ë„ëŸ¬ì¡Œë„¤!", "ê´œì°®ì•„, ê´œì°®ì•„.", "ì´ê±´ ì¢€ í—·ê°ˆë¦¬ëŠ” ë¬¸ì œì˜€ì–´,", "ì˜¤ë‹µ ë…¸íŠ¸ì— ì €ì¥!", "ë‹¤ì‹œ ì§‘ì¤‘í•´ë³´ì!", "í¬ê¸°ë§Œ ì•ˆ í•˜ë©´ ë¼!", "ë„ˆë¬´ ìì±…í•˜ì§€ ë§ˆ.", "ìŒ, ì´ê±´ ì¢€ ì–´ë ¤ì› ë‹¤.", "ê´œì°®ì•„, ìµíˆëŠ” ê³¼ì •ì´ì•¼!", "ë‹¤ì‹œ í•œë²ˆ ë³´ë©´ ë˜ì§€!", "ë‹¤ìŒ ë¬¸ì œì— ì§‘ì¤‘!", "ì˜ëª» ê³ ë¥¸ê±° ì•„ëƒ?.", "ì—ì´, ê´œì°®ì•„!.", "ì•„ê¹ë‹¤! í•œ ë— ì°¨ì´ì˜€ëŠ”ë°.", "í—·ê°ˆë ¸êµ¬ë‚˜?", "ì‹¬í˜¸í¡ í•œë²ˆ í•˜ê³  ë‹¤ì‹œ ê°€ì!" ];
        
        let userData = {}, currentUserId = null, allUsers = {}, soundEnabled = true, currentQuizRange = null;

        const startScreen = document.getElementById('start-screen'), quizScreen = document.getElementById('quiz-screen'), resultScreen = document.getElementById('result-screen'), startBtn = document.getElementById('start-btn'), restartBtn = document.getElementById('restart-btn'), retryIncorrectBtn = document.getElementById('retry-incorrect-btn'), questionText = document.getElementById('question-text'), optionButtons = document.querySelectorAll('.option'), scoreText = document.getElementById('score-text'), progressBar = document.getElementById('progress-bar'), timerDisplay = document.getElementById('timer'), characterFeedback = document.getElementById('character-feedback'), incorrectSection = document.getElementById('incorrect-answers-section'), incorrectList = document.getElementById('incorrect-answers-list'), levelDisplay = document.getElementById('level-display'), xpDisplay = document.getElementById('xp-display'), progressDisplay = document.getElementById('progress-display'), progressPercent = document.getElementById('progress-percent'), achievementPopup = document.getElementById('achievement-unlocked'), quizSelectionContainer = document.getElementById('quiz-selection'), hintBtn = document.getElementById('hint-btn'), quizStatsDisplay = document.getElementById('quiz-stats-display'), correctSound = document.getElementById('correct-sound'), incorrectSound = document.getElementById('incorrect-sound'), achievementSound = document.getElementById('achievement-sound'), mainTitle = document.getElementById('main-title'), settingsBtn = document.getElementById('settings-btn'), settingsModal = document.getElementById('settings-modal'), userSelect = document.getElementById('user-select'), addUserBtn = document.getElementById('add-user-btn'), deleteUserBtn = document.getElementById('delete-user-btn'), soundToggle = document.getElementById('sound-toggle'), closeSettingsBtn = document.getElementById('close-settings'), userMessage = document.getElementById('user-message'), nextQBtn = document.getElementById('next-q-btn'), gameMessageSpot = document.getElementById('game-message-spot');

        let currentQuizData = [], incorrectAnswersThisRound = [], comboCount = 0, currentQuestionIndex = 0, score = 0, timer, timeLeft = 15;
        let showWordAsQuestion = false, autoAdvance = true;

        const fullQuizData = [
            // (ì‚¬ìì„±ì–´ ë°ì´í„°ëŠ” ì–‘ì´ ë§ì•„ ìƒëµí•©ë‹ˆë‹¤.)
            { "id": 1, "question": "í¬ê²Œ ì†Œë¦¬ ë‚´ì–´ ì›ƒëŠ” ê²ƒ", "answer": "ê°€ê°€ëŒ€ì†Œ(å‘µå‘µå¤§ç¬‘)", "options": ["êµìì±„ì‹ (æ•å­æ¡è–ª)","ê°€ê°€ëŒ€ì†Œ(å‘µå‘µå¤§ç¬‘)","ë†ê°€ì„±ì§„(å¼„å‡æˆçœ)","ë‚™í™”ìœ ìˆ˜(è½èŠ±æµæ°´)"], "hint": "å‘µ(ê¾¸ì§–ì„ ê°€/ì›ƒìŒì†Œë¦¬ ê°€) ì›ƒë‹¤ì˜ ì˜ì„±ì–´ å‘µå‘µ í•˜í•˜ ì›ƒëŠ” ì›ƒìŒì†Œë¦¬ å¤§(í° ëŒ€) í¬ë‹¤ ç¬‘(ì›ƒì„ ì†Œ) ì›ƒë‹¤" },
            { "id": 2, "question": "ì§‘ì§‘ë§ˆë‹¤ ëª¨ë“  ì§‘ì„ ì˜ë¯¸í•¨", "answer": "ê°€ê°€í˜¸í˜¸(å®¶å®¶æˆ¶æˆ¶)", "options": ["ë°•ëŒê°•ê¸°(åšè¦½å¼·è¨˜)","í’ìˆ˜ì§€íƒ„(é¢¨æ¨¹ä¹‹å˜†)","ë‚­ì¤‘ì§€ì¶”(å›Šä¸­ä¹‹éŒ)","ê°€ê°€í˜¸í˜¸(å®¶å®¶æˆ¶æˆ¶)"], "hint": "í•œì í’€ì´ å®¶(ì§‘ ê°€) ê°€ì • ì§‘ å®¶(ì§‘ ê°€) ê°€ì • ì§‘ æˆ¶(ì§‘ í˜¸) ë¬¸ ì§‘ ê°€êµ¬ æˆ¶(ì§‘ í˜¸) ë¬¸ ì§‘ ê°€êµ¬" },
            // ...
            { "id": 400, "question": "ê²€ì€ ê³ ì–‘ì´ë“  í° ê³ ì–‘ì´ë“  ì¥ë§Œ ì˜ ì¡ìœ¼ë©´ ì¢‹ì€ ê³ ì–‘ì´ë‹¤", "answer": "í‘ë¬˜ë°±ë¬˜(é»‘çŒ«ç™½çŒ«)", "options": ["ê¸ˆìƒì²¨í™”(éŒ¦ä¸Šæ·»èŠ±)","í™”í•©ë™ì§„(å’ŒåˆåŒé€²)","í‘ë¬˜ë°±ë¬˜(é»‘çŒ«ç™½çŒ«)","ìœ êµ¬ë¬´ì–¸(æœ‰å£ç„¡è¨€)"], "hint": "í•œì í’€ì´ é»‘(ê²€ì„ í‘) ê²€ì€ìƒ‰ çŒ«(ê³ ì–‘ì´ ë¬˜) ê³ ì–‘ì´ ç™½(í° ë°±) í°ìƒ‰ çŒ«(ê³ ì–‘ì´ ë¬˜) ê³ ì–‘ì´" }
        ];

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('i');
            const isActive = content.style.display === "block";
            document.querySelectorAll(".accordion-content").forEach(c => {
                c.style.display = "none";
                const i = c.previousElementSibling.querySelector('i');
                if (i) i.textContent = 'â–¼';
            });
            if (!isActive) {
                content.style.display = "block";
                if (icon) icon.textContent = 'â–²';
            }
        }

        function showGameMessage(htmlContent, duration = 2000) {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = htmlContent;
            gameMessageSpot.innerHTML = '';
            gameMessageSpot.appendChild(messageElement);
            setTimeout(() => {
                if (gameMessageSpot.contains(messageElement)) {
                    gameMessageSpot.removeChild(messageElement);
                }
            }, duration);
        }

        function addXp(amount) {
            userData.xp += amount;
            if (userData.xp < 0) userData.xp = 0;
            const requiredXp = userData.level * 1000;
            if (userData.xp >= requiredXp) {
                userData.xp -= requiredXp;
                userData.level++;
                showGameMessage(`<div class="levelup-message">âœ¨ LEVEL UP! LV.${userData.level}</div>`, 3000);
                showAchievement(`âœ¨ğŸ†âœ¨ LEVEL UP! LV.${userData.level} ë‹¬ì„±ì„ ì¶•í•˜í•©ë‹ˆë‹¤!`);
            }
            const message = amount > 0 ? `+${amount}XP` : `${amount}XP`;
            showGameMessage(`<div class="xp-message">${message}</div>`);
            saveUserData();
            updateDashboard();
        }

        function selectAnswer(e) {
            clearInterval(timer);
            timerDisplay.classList.add('hidden');
            const selectedButton = e.target.closest('button');
            if (!selectedButton) return;
            const selectedAnswer = selectedButton.dataset.answer;
            const currentQuestion = currentQuizData[currentQuestionIndex];
            const correctAnswer = showWordAsQuestion ? currentQuestion.question : currentQuestion.answer;
            hintBtn.classList.add('hidden');
            showHint(true);
            if (selectedAnswer === correctAnswer) {
                selectedButton.classList.add('correct');
                score++;
                comboCount++;
                let baseXp = 100 + (comboCount >= 2 ? comboCount * 10 : 0);
                addXp(baseXp);
                playSound(correctSound);
                const randomMessage = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                characterFeedback.textContent = `${currentUserId}, ${randomMessage}`;
                characterFeedback.style.color = 'var(--correct-color)';
                characterFeedback.classList.add('show');
                if (comboCount >= 2) {
                    setTimeout(() => showGameMessage(`<div class="combo-message">ğŸ”¥ ${comboCount} COMBO!</div>`), 500);
                }
                if (!userData.masteredWords.includes(currentQuestion.id)) {
                    userData.masteredWords.push(currentQuestion.id);
                }
                userData.incorrectNote = userData.incorrectNote.filter(id => id !== currentQuestion.id);
            } else {
                selectedButton.classList.add('incorrect');
                incorrectAnswersThisRound.push(currentQuestion);
                comboCount = 0;
                playSound(incorrectSound);
                const randomMessage = wrongMessages[Math.floor(Math.random() * wrongMessages.length)];
                characterFeedback.textContent = `${currentUserId}, ${randomMessage}`;
                characterFeedback.style.color = 'var(--incorrect-color)';
                characterFeedback.classList.add('show');
                if (!userData.incorrectNote.includes(currentQuestion.id)) {
                    userData.incorrectNote.push(currentQuestion.id);
                }
                optionButtons.forEach(button => {
                    if (button.dataset.answer === correctAnswer) button.classList.add('correct');
                });
            }
            optionButtons.forEach(button => button.disabled = true);
            if (autoAdvance) {
                moveToNextQuestion(2000);
            } else {
                nextQBtn.classList.remove('hidden');
            }
        }

        function resetState() {
            characterFeedback.classList.remove('show');
            optionButtons.forEach(button => {
                button.disabled = false;
                button.className = 'option';
            });
            nextQBtn.classList.add('hidden');
            gameMessageSpot.innerHTML = '';
            hintBtn.classList.remove('hidden');
        }

        function handleTimeUp() {
            clearInterval(timer);
            const currentQuestion = currentQuizData[currentQuestionIndex];
            const correctAnswer = showWordAsQuestion ? currentQuestion.question : currentQuestion.answer;
            incorrectAnswersThisRound.push(currentQuestion);
            if (!userData.incorrectNote.includes(currentQuestion.id)) {
                userData.incorrectNote.push(currentQuestion.id);
            }
            comboCount = 0;
            playSound(incorrectSound);
            const randomMessage = wrongMessages[Math.floor(Math.random() * wrongMessages.length)];
            characterFeedback.textContent = `ì‹œê°„ ì´ˆê³¼! ${currentUserId}, ${randomMessage}`;
            characterFeedback.classList.add('show');
            characterFeedback.style.color = 'var(--incorrect-color)';
            optionButtons.forEach(button => {
                if (button.dataset.answer === correctAnswer) button.classList.add('correct');
                button.disabled = true;
            });
            if (autoAdvance) {
                moveToNextQuestion(2000);
            } else {
                nextQBtn.classList.remove('hidden');
            }
        }

        function playSound(sound) {
            if (!soundEnabled) return;
            sound.currentTime = 0;
            sound.play().catch(e => console.warn("Sound play was blocked."));
        }

        // --- Settings Functions ---
        function loadSettings() {
            const savedSound = localStorage.getItem('soundEnabled');
            soundEnabled = savedSound === null ? true : JSON.parse(savedSound);
            soundToggle.checked = soundEnabled;

            const savedDirection = localStorage.getItem('showWordAsQuestion');
            showWordAsQuestion = savedDirection === 'true';
            document.getElementById('question-direction-toggle').checked = showWordAsQuestion;

            const savedAutoAdvance = localStorage.getItem('autoAdvanceEnabled');
            autoAdvance = savedAutoAdvance === null ? true : savedAutoAdvance === 'true';
            document.getElementById('auto-advance-toggle').checked = autoAdvance;

            const savedDarkMode = localStorage.getItem('darkModeEnabled');
            const isDarkMode = savedDarkMode === 'true';
            document.getElementById('dark-mode-toggle').checked = isDarkMode;
            applyDarkMode(isDarkMode);

            const savedCustomToggle = localStorage.getItem('customSettingEnabled');
            document.getElementById('custom-setting-toggle').checked = savedCustomToggle === 'true';
            updateQuizSelectionVisibility();
        }

        function applyDarkMode(enabled) {
            document.body.classList.toggle('dark-mode', enabled);
        }

        function updateQuizSelectionVisibility() {
            const useCustom = document.getElementById('custom-setting-toggle').checked;
            document.getElementById('quiz-selection').style.display = useCustom ? 'none' : 'block';
            document.getElementById('custom-quiz-selection').style.display = useCustom ? 'block' : 'none';
        }

        // --- User Management ---
        function loadAllUsers() {
            const savedUsers = localStorage.getItem('wordMasterUsers');
            if (savedUsers) {
                allUsers = JSON.parse(savedUsers);
            } else {
                allUsers['ì´ˆë¯¸ë¹„ë‹ˆ'] = { level: 1, xp: 0, masteredWords: [], incorrectNote: [], achievements: [] };
                saveAllUsers();
            }
        }

        function createUser(username) {
            username = username?.trim();
            if (!username) return false;
            if (username.length > 8) {
                showUserMessage("âŒ ì‚¬ìš©ìëª…ì€ ìµœëŒ€ 8ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
                return false;
            }
            if (allUsers[username]) {
                showUserMessage('â— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤!');
                return false;
            }
            allUsers[username] = { level: 1, xp: 0, masteredWords: [], incorrectNote: [], achievements: [] };
            saveAllUsers();
            populateUserSelect();
            setCurrentUser(username);
            showUserMessage(`"ğŸ‰ ${username}" ì‚¬ìš©ìê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            return true;
        }

        function addUser() {
            const newUsername = prompt('ìƒˆ ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 8ì):', '');
            if (newUsername) createUser(newUsername);
        }

        function deleteUser() {
            const username = userSelect.value;
            if (!username) { showUserMessage('ì‚­ì œí•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
            if (Object.keys(allUsers).length <= 1) { showUserMessage('ìµœì†Œ í•œ ëª…ì˜ ì‚¬ìš©ìê°€ í•„ìš”í•©ë‹ˆë‹¤!'); return; }
            if (!confirm(`"${username}" ì‚¬ìš©ìë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  í•™ìŠµ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤!`)) return;
            delete allUsers[username];
            saveAllUsers();
            populateUserSelect();
            const firstUserId = Object.keys(allUsers)[0];
            if (firstUserId) {
                setCurrentUser(firstUserId);
            }
        }

        function populateUserSelect() {
            userSelect.innerHTML = '';
            Object.keys(allUsers).forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                userSelect.appendChild(option);
            });
            if (currentUserId) userSelect.value = currentUserId;
        }

        function setCurrentUser(username) {
            if (!allUsers[username]) return;
            currentUserId = username;
            userData = allUsers[username];
            userSelect.value = username;
            updateDashboard();
            mainTitle.innerHTML = `${currentUserId}ì˜<br>ì‚¬ìì„±ì–´ ìª¼ê°œê¸°`;
        }

        function showUserMessage(message) {
            userMessage.textContent = message;
            userMessage.classList.add('show');
            setTimeout(() => userMessage.classList.remove('show'), 3000);
        }

        function saveAllUsers() {
            localStorage.setItem('wordMasterUsers', JSON.stringify(allUsers));
        }

        function saveUserData() {
            if (currentUserId) {
                allUsers[currentUserId] = userData;
                saveAllUsers();
            }
        }

        // --- UI Updates ---
        function updateDashboard() {
            if (!userData) return;
            levelDisplay.textContent = userData.level;
            xpDisplay.textContent = userData.xp;
            const masteredCount = new Set(userData.masteredWords).size;
            const totalCount = fullQuizData.length;
            progressDisplay.textContent = `${masteredCount} / ${totalCount}`;
            const percent = totalCount > 0 ? ((masteredCount / totalCount) * 100).toFixed(1) : 0;
            progressPercent.textContent = ` (${percent}%)`;
            const incorrectCount = new Set(userData.incorrectNote).size;
            document.getElementById('incorrect-count').textContent = incorrectCount;
            const incorrectRadioLabel = document.querySelector('label.quiz-range input[value="incorrect"]')?.parentElement;
            if (incorrectRadioLabel) {
                if (incorrectCount === 0) {
                    incorrectRadioLabel.style.opacity = '0.5';
                    incorrectRadioLabel.style.pointerEvents = 'none';
                } else {
                    incorrectRadioLabel.style.opacity = '1';
                    incorrectRadioLabel.style.pointerEvents = 'auto';
                }
            }
            updateQuizStats();
        }

        function updateQuizStats() {
            if (!userData) return;
            const requiredXp = userData.level * 1000;
            quizStatsDisplay.innerHTML = `<strong>LV.${userData.level}</strong> (${userData.xp}/${requiredXp} XP)`;
        }

        function showAchievement(message) {
            achievementPopup.textContent = message;
            achievementPopup.classList.add('show');
            playSound(achievementSound);
            setTimeout(() => achievementPopup.classList.remove('show'), 3000);
        }

        // --- Quiz Flow ---
        function createQuizSelection() {
            quizSelectionContainer.innerHTML = '';
            const wordsPerGroup = 20;
            const groupCount = Math.ceil(fullQuizData.length / wordsPerGroup);
            for (let i = 0; i < groupCount; i++) {
                const startNum = i * wordsPerGroup + 1;
                const endNum = Math.min((i + 1) * wordsPerGroup, fullQuizData.length);
                const label = document.createElement('label');
                label.className = 'quiz-range';
                label.innerHTML = `<input type="radio" name="quizRange" value="${startNum - 1}-${endNum - 1}"><span> #${String(startNum).padStart(4, '0')} ~ #${String(endNum).padStart(4, '0')}</span>`;
                quizSelectionContainer.appendChild(label);
            }
            const incorrectLabel = document.createElement('label');
            incorrectLabel.className = 'quiz-range';
            incorrectLabel.innerHTML = `<input type="radio" name="quizRange" value="incorrect"><span> ì˜¤ë‹µ ë…¸íŠ¸ ì±Œë¦°ì§€ (<span id="incorrect-count">0</span>ê°œ)</span>`;
            quizSelectionContainer.appendChild(incorrectLabel);
        }

        function startQuiz() {
            const useCustom = document.getElementById('custom-setting-toggle').checked;
            if (useCustom) {
                let startIdx = parseInt(document.getElementById('custom-range-start').value) - 1;
                let endIdx = parseInt(document.getElementById('custom-range-end').value);
                let count = parseInt(document.getElementById('custom-question-count').value || 5);
                if (isNaN(startIdx) || isNaN(endIdx) || startIdx < 0 || endIdx <= startIdx || endIdx > fullQuizData.length) { alert('ìœ íš¨í•œ í€´ì¦ˆ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if (isNaN(count) || count < 3 || count > 20) { alert('ë¬¸ì œ ìˆ˜ëŠ” 3ì—ì„œ 20 ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
                currentQuizData = fullQuizData.slice(startIdx, endIdx).sort(() => 0.5 - Math.random()).slice(0, count);
            } else {
                const selectedRadio = document.querySelector('input[name="quizRange"]:checked');
                if (!selectedRadio) { alert('í€´ì¦ˆ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
                currentQuizRange = selectedRadio.value;
                if (currentQuizRange === 'incorrect') {
                    if (userData.incorrectNote.length === 0) { alert('ì˜¤ë‹µ ë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!'); return; }
                    const incorrectNoteSet = new Set(userData.incorrectNote);
                    currentQuizData = fullQuizData.filter(q => incorrectNoteSet.has(q.id)).sort(() => 0.5 - Math.random());
                } else {
                    const [startId, endId] = currentQuizRange.split('-').map(Number);
                    currentQuizData = fullQuizData.slice(startId, endId + 1).sort(() => 0.5 - Math.random());
                }
            }
            if (currentQuizData.length === 0) { alert('ì„ íƒí•œ ë²”ìœ„ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            incorrectAnswersThisRound = [];
            currentQuestionIndex = 0;
            score = 0;
            comboCount = 0;
            updateQuizStats();
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            showQuestion();
        }
        
        function startTimer() {
            timeLeft = 15;
            timerDisplay.textContent = timeLeft;
            timerDisplay.classList.remove('hidden');
            clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    handleTimeUp();
                }
            }, 1000);
        }

        function showQuestion() {
            resetState();
            const currentQuestion = currentQuizData[currentQuestionIndex];
            let questionHTML = `Q${currentQuestionIndex + 1}. `;
            let options = [];
            if (showWordAsQuestion) {
                questionHTML += `<strong>${currentQuestion.answer}</strong>`;
                const distractors = fullQuizData.filter(q => q.id !== currentQuestion.id);
                options = distractors.sort(() => 0.5 - Math.random()).slice(0, 3).map(q => q.question);
                options.push(currentQuestion.question);
            } else {
                questionHTML += currentQuestion.question;
                options = [...currentQuestion.options];
            }
            questionText.innerHTML = questionHTML;
            const shuffledOptions = options.sort(() => 0.5 - Math.random());
            optionButtons.forEach((button, index) => {
                button.innerText = shuffledOptions[index];
                button.dataset.answer = shuffledOptions[index];
            });
            hintBtn.classList.remove('hidden');
            updateProgressBar();
            startTimer();
        }
        
        function moveToNextQuestion(delay = 0) { setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < currentQuizData.length) { showQuestion(); } else { showResult(); } }, delay); }
        function updateProgressBar() { const progress = ((currentQuestionIndex + 1) / currentQuizData.length) * 100; progressBar.style.width = `${progress}%`; }

        function showResult() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            scoreText.innerHTML = `ì´ <strong>${currentQuizData.length}</strong> ë¬¸ì œ ì¤‘ <strong>${score}</strong>ê°œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤!`;
            if (incorrectAnswersThisRound.length > 0) {
                incorrectSection.classList.remove('hidden');
                retryIncorrectBtn.classList.remove('hidden');
                incorrectList.innerHTML = '';
                incorrectAnswersThisRound.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${item.answer}</strong>: ${item.question}`;
                    incorrectList.appendChild(li);
                });
            } else {
                incorrectSection.classList.add('hidden');
                retryIncorrectBtn.classList.add('hidden');
                scoreText.innerHTML += "<br>ğŸ‰ <strong>ì™„ë²½í•´ìš”!</strong>";
                if (currentQuizData.length >= 10 && !userData.achievements.includes('perfect10')) {
                    showAchievement('ğŸ† ë„ì „ ê³¼ì œ: 10ë¬¸ì œ ì´ìƒ ì™„ë²½ í´ë¦¬ì–´!');
                    userData.achievements.push('perfect10');
                }
            }
            saveUserData();
            updateDashboard();
        }

        function showHint(force = false) {
            const currentQuestion = currentQuizData?.[currentQuestionIndex];
            if (!currentQuestion) return;
            const hintContent = currentQuestion?.hint ? `<small style='font-size:1rem; color:#666;'>ğŸ’¡ ${currentQuestion.hint}</small>` : "<small style='font-size:1rem; color:#999;'>â— íŒíŠ¸ê°€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>";
            questionText.innerHTML = hintContent;
            hintBtn.classList.add('hidden');
        }

        function showStartScreen() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            document.querySelectorAll(".quiz-range.selected").forEach(r => r.classList.remove("selected"));
            startBtn.disabled = true;
            startBtn.textContent = 'í€´ì¦ˆ ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”';
            currentQuizRange = null;
        }

        // --- Initializer ---
        function initializeApp() {
            loadAllUsers();
            createQuizSelection();
            populateUserSelect();
            
            const firstUserId = Object.keys(allUsers)[0];
            if (firstUserId) {
                setCurrentUser(firstUserId);
            }
            
            loadSettings();

            // --- Event Listeners ---
            startBtn.addEventListener('click', startQuiz);
            restartBtn.addEventListener('click', showStartScreen);
            retryIncorrectBtn.addEventListener('click', () => {
                const incorrectRadio = quizSelectionContainer.querySelector('input[value="incorrect"]');
                if (incorrectRadio) {
                    incorrectRadio.checked = true;
                    // Manually trigger visual update for selection
                    document.querySelectorAll('.quiz-range').forEach(label => label.classList.remove('selected'));
                    incorrectRadio.parentElement.classList.add('selected');
                }
                startQuiz();
            });

            nextQBtn.addEventListener('click', () => moveToNextQuestion());
            optionButtons.forEach(button => button.addEventListener('click', selectAnswer));
            hintBtn.addEventListener('click', () => showHint(false));
            
            settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            
            addUserBtn.addEventListener('click', addUser);
            deleteUserBtn.addEventListener('click', deleteUser);
            userSelect.addEventListener('change', () => setCurrentUser(userSelect.value));
            
            // Settings Toggles
            soundToggle.addEventListener('change', () => { soundEnabled = soundToggle.checked; localStorage.setItem('soundEnabled', soundEnabled); });
            document.getElementById('question-direction-toggle').addEventListener('change', (e) => { showWordAsQuestion = e.target.checked; localStorage.setItem('showWordAsQuestion', showWordAsQuestion); });
            document.getElementById('auto-advance-toggle').addEventListener('change', (e) => { autoAdvance = e.target.checked; localStorage.setItem('autoAdvanceEnabled', autoAdvance); });
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => { const isEnabled = e.target.checked; applyDarkMode(isEnabled); localStorage.setItem('darkModeEnabled', isEnabled); });
            document.getElementById('custom-setting-toggle').addEventListener('change', (e) => { updateQuizSelectionVisibility(); localStorage.setItem('customSettingEnabled', e.target.checked); });
            
            // âœ… **FIX**: Event listener for quiz selection
            quizSelectionContainer.addEventListener('click', (e) => {
                const targetLabel = e.target.closest('.quiz-range');
                if (!targetLabel) return;
                
                const radio = targetLabel.querySelector('input[type="radio"]');
                if (radio && radio.disabled) return;

                document.querySelectorAll('.quiz-range').forEach(label => label.classList.remove('selected'));
                targetLabel.classList.add('selected');

                if (radio) { radio.checked = true; }
                
                startBtn.disabled = false;
                startBtn.textContent = 'í€´ì¦ˆ ì‹œì‘!';
            });

            // âœ… **FIX**: Event listener for settings accordion
            document.querySelectorAll('.accordion-section > div:first-child').forEach(header => {
                header.addEventListener('click', () => {
                    toggleAccordion(header);
                });
            });
        }
        
        // Let's go!
        initializeApp();
    });
</script>
